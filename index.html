<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Wholesale Land CRM (Web)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#f8fafc;--card:#fff;--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--brand:#059669;--brand2:#4f46e5;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial}
    h1{margin:16px 0}
    .container{padding:24px}
    .btn{border:1px solid transparent;background:#111827;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn:hover{filter:brightness(0.95)}
    .btn.ghost{background:#fff;border-color:#d1d5db;color:#111827}
    .btn.brand{background:var(--brand)}
    .btn.indigo{background:var(--brand2)}
    .btn:disabled{background:#9ca3af;cursor:not-allowed}
    .tabs button{border:1px solid #d1d5db;background:#fff;color:#111827;border-radius:8px;padding:8px 12px}
    .tabs .active{background:var(--brand);color:#fff;border-color:transparent}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .input, select, textarea{border:1px solid #d1d5db;border-radius:8px;padding:8px 10px}
    .input{min-width:260px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .card .hd{border-bottom:1px solid var(--line);padding:12px 12px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left}
    thead th{background:#f3f4f6;color:#475569;font-size:12px;text-transform:uppercase}
    .grid{display:grid;gap:16px}
    @media(min-width:1024px){.grid-2{grid-template-columns:1fr 1fr}}
    .hview{height:78vh;display:flex;flex-direction:column;overflow:hidden}
    .scroll{flex:1;overflow:auto;min-height:0}
    .muted{color:var(--muted);font-size:12px}
    .chip{border:1px solid #d1d5db;border-radius:6px;padding:4px 8px;font-size:12px;background:#fff;cursor:pointer}
    .chip.active{background:var(--brand);color:#fff;border-color:transparent}
    .note{width:100%;height:96px}
    .table-lite{max-height:160px;overflow:auto}
    .row-details{display:grid;grid-template-columns:1fr 1fr;gap:12px;border-top:1px solid var(--line);padding:12px}
    .info label{display:block;color:#64748b;font-size:12px}
    .info div{word-break:break-word;font-weight:600}
    .mb-8{margin-bottom:8px}.mb-16{margin-bottom:16px}.mt-12{margin-top:12px}.mt-16{margin-top:16px}
    .w-20{width:80px}.w-72{width:18rem}.small{font-size:12px}
    .center{display:flex;align-items:center;justify-content:center}
    .selected{background:#ecfdf5}
    .kbd{background:#eef2ff;border:1px solid #c7d2fe;border-radius:6px;padding:2px 6px;font-size:12px}
  </style>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div class="container"><div id="root"></div></div>

  <script src="crm-logic.js"></script>
  <script type="text/babel">
    const {useEffect, useMemo, useRef, useState} = React;

    const CRM = window.CRM_LOGIC || {};
    const DEFAULT_HISTORY_TYPES = ["Note","Call","Offer","Follow-up","Task","Status","Assignment","Lead Assignment"];
    const DEFAULT_GEOCODE_PROVIDERS = [
      {
        name: "OpenStreetMap",
        buildUrl: (query)=>`https://nominatim.openstreetmap.org/search?format=json&limit=1&addressdetails=0&email=landcrm-demo@example.com&q=${encodeURIComponent(query)}`,
        parse: (payload)=>{
          if(Array.isArray(payload) && payload[0]){
            const lat=Number(payload[0].lat), lon=Number(payload[0].lon);
            if(Number.isFinite(lat) && Number.isFinite(lon)) return {lat, lon};
          }
          return null;
        }
      },
      {
        name: "Maps.co",
        buildUrl: (query)=>`https://geocode.maps.co/search?q=${encodeURIComponent(query)}&limit=1`,
        parse: (payload)=>{
          if(Array.isArray(payload) && payload[0]){
            const lat=Number(payload[0].lat), lon=Number(payload[0].lon);
            if(Number.isFinite(lat) && Number.isFinite(lon)) return {lat, lon};
          }
          return null;
        }
      },
      {
        name: "Open-Meteo",
        buildUrl: (query)=>`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=1&language=en`,
        parse: (payload)=>{
          const result = payload?.results?.[0];
          if(result){
            const lat=Number(result.latitude), lon=Number(result.longitude);
            if(Number.isFinite(lat) && Number.isFinite(lon)) return {lat, lon};
          }
          return null;
        }
      }
    ];
    const HISTORY_TYPES = Array.isArray(CRM.HISTORY_TYPES) && CRM.HISTORY_TYPES.length ? CRM.HISTORY_TYPES : DEFAULT_HISTORY_TYPES;
    const fallbackFormatDateTime = (iso)=>{
      if(!iso) return "";
      try{ return new Date(iso).toLocaleString(); }
      catch{ return iso || ""; }
    };
    const formatDateTime = typeof CRM.formatDateTime === "function" ? CRM.formatDateTime : fallbackFormatDateTime;
    const makeId = typeof CRM.makeId === "function" ? CRM.makeId : (()=>`id_${Math.random().toString(36).slice(2)}_${Date.now().toString(36)}`);
    const makeHistoryEntry = typeof CRM.makeHistoryEntry === "function" ? CRM.makeHistoryEntry : ((type, note)=>({id:makeId(), type:type||"Note", note:note ?? "", timestamp:new Date().toISOString()}));
    const {DEFAULT_SAMPLE_LEADS, DEFAULT_SAMPLE_BUYERS} = (()=>{
      const now = Date.now();
      const isoDaysAgo = (days)=> new Date(now - days*86400000).toISOString();
      const entry = (days, type, note)=> ({...makeHistoryEntry(type, note), timestamp: isoDaysAgo(days)});
      return {
        DEFAULT_SAMPLE_LEADS: [
          {
            "Owner Name": "John & Jane Sample",
            County: "Citrus",
            City: "Citrus Springs",
            State: "FL",
            Zip: "34433",
            "Site Address": "1234 W Elm Dr, Citrus Springs, FL 34433",
            "Estimated Market Value": "$12,500",
            Latitude: 28.9723,
            Longitude: -82.4891,
            APN: "18E17S100010 01230 0120",
            Acreage: "0.24",
            Cell: "(352) 555-0199",
            "Email 1": "john.sample@citrusland.com",
            Status: "Contacted",
            __notes: "Seller is open to a clean cash offer with a quick close.",
            __nextAction: "Send purchase agreement draft",
            __lastContacted: isoDaysAgo(2).slice(0,10),
            __assignedBuyerId: null,
            __history: [
              entry(6, "Call", "Spoke with John ‚Äì property is vacant and taxes are current."),
              entry(4, "Note", "Mailed follow-up packet with offer range."),
              entry(1, "Offer", "Working on written offer around $9,500.")
            ]
          },
          {
            "Owner Name": "Acme Holdings LLC",
            County: "Citrus",
            City: "Citrus Springs",
            State: "FL",
            Zip: "34433",
            "Site Address": "9876 N Maple Way, Citrus Springs, FL 34433",
            "Estimated Market Value": "$14,900",
            Latitude: 28.9677,
            Longitude: -82.4612,
            APN: "18E17S100020 04560 0070",
            Acreage: "0.25",
            "Phone 1": "(352) 555-0142",
            "Email 1": "offers@acmeholdings.example",
            Status: "New",
            __notes: "Cold mailer response asking for quick valuation.",
            __nextAction: "Research comps and call back",
            __lastContacted: isoDaysAgo(5).slice(0,10),
            __assignedBuyerId: null,
            __history: [
              entry(10, "Note", "Lead imported from PropStream CSV."),
              entry(3, "Task", "Pull three nearby sold comps.")
            ]
          }
        ],
        DEFAULT_SAMPLE_BUYERS: [
          {
            "Buyer Name / Company":"LandPath Ventures",
            "Buy Box - Counties":"Citrus; Marion",
            "Buy Box - States":"FL",
            "Min Acres":"0.2",
            "Max Acres":"10",
            "Min Price":"$5,000",
            "Max Price":"$80,000",
            "Funding Type (Cash/Hard Money)":"Cash",
            "Phone":"(352) 555-0118",
            "Email":"offers@landpath.com",
            __notes: "Prefers infill lots close to paved roads.",
            __history: [
              entry(25, "Assignment", "Closed Inverness lot assignment in May."),
              entry(7, "Call", "Interested in 0.25-0.5 acre inventory in Citrus.")
            ]
          },
          {
            "Buyer Name / Company":"Sunstate Holdings",
            "Buy Box - Counties":"Hernando; Citrus",
            "Buy Box - States":"FL",
            "Min Acres":"0.18",
            "Max Acres":"5",
            "Min Price":"$3,000",
            "Max Price":"$65,000",
            "Funding Type (Cash/Hard Money)":"Cash",
            "Phone":"(813) 555-0194",
            "Email":"acq@sunstate.com",
            __notes: "Will take down multiple lots at once.",
            __history: [
              entry(14, "Note", "Met at Tampa meetup ‚Äì send over Citrus list weekly.")
            ]
          },
          {
            "Buyer Name / Company":"Trailblazer Capital",
            "Buy Box - Counties":"Polk; Lake",
            "Buy Box - States":"FL",
            "Min Acres":"0.25",
            "Max Acres":"12",
            "Min Price":"$8,000",
            "Max Price":"$120,000",
            "Funding Type (Cash/Hard Money)":"Hard Money",
            "Phone":"(407) 555-0137",
            "Email":"closings@trailblazer.cap",
            __notes: "Has rehab crew for light clearing; needs 30-day close.",
            __history: [
              entry(5, "Call", "Checking on Polk pipeline; asked for 3 new deals.")
            ]
          }
        ]
      };
    })();
    const PHONE_FIELDS = [
      "Cell","Cell 2","Cell 3","Landline","Landline 2","Landline 3","Landline 4",
      "Phone","Phone 1","Phone 2","Phone 3","Other Phone","Primary Phone","Secondary Phone"
    ];
    const EMAIL_FIELDS = ["Email","Email 1","Email 2","Email 3","Primary Email","Secondary Email"];
    const normalizeCoordinate = typeof CRM.normalizeCoordinate === "function" ? CRM.normalizeCoordinate : ((value)=>{
      if(value === null || value === undefined) return undefined;
      if(typeof value === "number") return Number.isFinite(value) ? value : undefined;
      const raw = String(value).trim();
      if(!raw) return undefined;
      const cleaned = raw.replace(/[^0-9.\-]/g, "");
      if(!cleaned || cleaned === "-" || cleaned === "." || cleaned === "-." || cleaned === ".-") return undefined;
      const numeric = Number(cleaned);
      return Number.isFinite(numeric) ? numeric : undefined;
    });
    const leadHasCoordinates = typeof CRM.leadHasCoordinates === "function" ? CRM.leadHasCoordinates : ((lead)=>{
      if(!lead || typeof lead !== "object") return false;
      const lat = normalizeCoordinate(lead?.Latitude);
      const lon = normalizeCoordinate(lead?.Longitude);
      return Number.isFinite(lat) && Number.isFinite(lon);
    });
    const normalizePhoneHref = (value)=>{
      const digits = String(value ?? "").replace(/[^0-9+]/g,"");
      if(!digits) return "";
      if(digits.startsWith("+")) return digits;
      if(digits.length===11 && digits.startsWith("1")) return `+${digits}`;
      if(digits.length===10) return `+1${digits}`;
      return digits;
    };
    const sanitizeHistory = typeof CRM.sanitizeHistory === "function" ? CRM.sanitizeHistory : ((list)=>{
      if(!Array.isArray(list)) return [];
      return list.map(entry=>{
        if(entry && typeof entry === "object"){
          return {
            id: entry.id || makeId(),
            type: entry.type || entry.kind || "Note",
            note: entry.note ?? entry.text ?? "",
            timestamp: entry.timestamp || entry.date || new Date().toISOString()
          };
        }
        const value = String(entry ?? "");
        return {id:makeId(), type:"Note", note:value, timestamp:new Date().toISOString()};
      });
    });
    const sleep = typeof CRM.sleep === "function" ? CRM.sleep : ((ms)=> new Promise(resolve=>setTimeout(resolve, ms)));
    const toNumber = typeof CRM.toNumber === "function" ? CRM.toNumber : ((x)=>{
      const raw = String(x ?? "").replace(/[$,\s]/g,"");
      if(!raw) return undefined;
      const n = Number(raw);
      return Number.isFinite(n) ? n : undefined;
    });
    const cleanLeadRecord = typeof CRM.cleanLeadRecord === "function" ? CRM.cleanLeadRecord : ((o={})=>({
      ...o,
      Latitude: normalizeCoordinate(o.Latitude),
      Longitude: normalizeCoordinate(o.Longitude),
      __history: sanitizeHistory(o.__history),
      __id: o.__id || makeId()
    }));
    const cleanBuyerRecord = typeof CRM.cleanBuyerRecord === "function" ? CRM.cleanBuyerRecord : ((o={})=>({
      ...o,
      __history: sanitizeHistory(o.__history),
      __id: o.__id || makeId()
    }));
    const GEOCODE_PROVIDERS = Array.isArray(CRM.GEOCODE_PROVIDERS) && CRM.GEOCODE_PROVIDERS.length ? CRM.GEOCODE_PROVIDERS : DEFAULT_GEOCODE_PROVIDERS;
    const sampleLeads = Array.isArray(CRM.sampleLeads) && CRM.sampleLeads.length ? CRM.sampleLeads : DEFAULT_SAMPLE_LEADS;
    const sampleBuyers = Array.isArray(CRM.sampleBuyers) && CRM.sampleBuyers.length ? CRM.sampleBuyers : DEFAULT_SAMPLE_BUYERS;

    function App(){
      const [tab, setTab] = useState("leads");

      // Leads
      const [leads, setLeads] = useState(()=> sampleLeads.map(cleanLeadRecord));
      const [search, setSearch] = useState("");
      const [countyFilter, setCountyFilter] = useState("");
      const [selectedIndex, setSelectedIndex] = useState(0);
      const [leadLogType, setLeadLogType] = useState("Note");
      const [leadLogText, setLeadLogText] = useState("");
      const [importMode, setImportMode] = useState("append");
      const [mapEnabled, setMapEnabled] = useState(true);
      const [mapType, setMapType] = useState("street");
      const [compRadius, setCompRadius] = useState(5);
      const [geocodeBusy, setGeocodeBusy] = useState(false);
      const [geocodeProgress, setGeocodeProgress] = useState({done:0,total:0});
      const [geocodeStatus, setGeocodeStatus] = useState("");
      const geocodeCacheRef = useRef(new Map());

      // Buyers
      const [buyers, setBuyers] = useState(()=> sampleBuyers.map(cleanBuyerRecord));
      const [selectedBuyerId, setSelectedBuyerId] = useState(null);
      const [buyerCounty, setBuyerCounty] = useState("");
      const [minAcres, setMinAcres] = useState("");
      const [maxAcres, setMaxAcres] = useState("");
      const [minPrice, setMinPrice] = useState("");
      const [maxPrice, setMaxPrice] = useState("");
      const [buyersImportMode, setBuyersImportMode] = useState("append");
      const [buyerLogType, setBuyerLogType] = useState("Note");
      const [buyerLogText, setBuyerLogText] = useState("");

      const leadLabel = (lead)=>{
        if(!lead) return "Lead";
        const owner=lead["Owner Name"]||"";
        const address=lead["Site Address"]||"";
        if(owner && address) return `${owner} ‚Äì ${address}`;
        return owner || address || lead.APN || "Lead";
      };
      const buyerLabel = (buyer)=> buyer?.["Buyer Name / Company"] || buyer?.Company || buyer?.Name || "Buyer";
      const updateLeadById = (id, updater)=>{
        if(!id) return;
        setLeads(prev=>{
          const idx = prev.findIndex(l=>l.__id===id);
          if(idx===-1) return prev;
          const clone=prev.slice();
          const current=prev[idx];
          const updated=updater(current)||current;
          clone[idx]=updated;
          return clone;
        });
      };
      const updateBuyerById = (id, updater)=>{
        if(!id) return;
        setBuyers(prev=>{
          const idx=prev.findIndex(b=>b.__id===id);
          if(idx===-1) return prev;
          const clone=prev.slice();
          const current=prev[idx];
          const updated=updater(current)||current;
          clone[idx]=updated;
          return clone;
        });
      };

      // Load / save
      useEffect(()=>{
        try{
          const s = localStorage.getItem("land_crm_leads");
          if (s){
            const parsed = JSON.parse(s);
            if(Array.isArray(parsed)){
              setLeads(parsed.map(cleanLeadRecord));
            }
          }
        }catch(err){ console.warn("Failed to load saved leads", err); }
        try{
          const b = localStorage.getItem("land_crm_buyers");
          if (b){
            const parsedB = JSON.parse(b);
            if(Array.isArray(parsedB)){
              setBuyers(parsedB.map(cleanBuyerRecord));
            }
          }
        }catch(err){ console.warn("Failed to load saved buyers", err); }
        setSelectedIndex(0);
      },[]);
      useEffect(()=>{ try{localStorage.setItem("land_crm_leads", JSON.stringify(leads));}catch{} },[leads]);
      useEffect(()=>{ try{localStorage.setItem("land_crm_buyers", JSON.stringify(buyers));}catch{} },[buyers]);

      // CSV
      function parseCSV(text){
        const rows=[]; let cur=[], val="", inQ=false;
        const endVal=()=>{cur.push(val);val="";}; const endRow=()=>{rows.push(cur);cur=[];};
        for(let i=0;i<text.length;i++){
          const c=text[i];
          if(inQ){
            if(c==='\"'){ if(text[i+1]==='\"'){val+='\"';i++;} else {inQ=false;} }
            else { val+=c; }
          }else{
            if(c==='\"'){ inQ=true; }
            else if(c===',') endVal();
            else if(c==='\n'){ endVal(); endRow(); }
            else if(c==='\r'){ /* ignore */ }
            else { val+=c; }
          }
        }
        endVal(); if(cur.length) endRow();
        while(rows.length && rows[rows.length-1].every(x=>x==="")) rows.pop();
        return rows;
      }
      function normalizeHeaders(headers){
        const map = {
          "owner 1 full name":"Owner Name","owner 1 first name":"Owner Name","owner name":"Owner Name",owner:"Owner Name",
          county:"County","property county":"County","situs city":"Site City","situs state":"Site State","situs zip":"Site Zip",
          "situs house number":"Site Address","situs street name":"Site Address","property address":"Site Address",address:"Site Address",
          apn:"APN","assessor parcel number (apn)":"APN","lot acreage":"Acreage",acreage:"Acreage",latitude:"Latitude",longitude:"Longitude",
          "estimated value":"Estimated Market Value","est. value":"Estimated Market Value","estimated market value":"Estimated Market Value",
          phone:"Phone 1","phone 1":"Phone 1","phone 2":"Phone 2",email:"Email",
          "first name":"First Name","last name":"Last Name","company name":"Company Name","street address":"Street Address",
          city:"City",state:"State",zip:"Zip","mail street address":"Mail Street Address","mail city":"Mail City","mail state":"Mail State","mail zip":"Mail Zip",
          cell:"Cell","cell 2":"Cell 2","cell 3":"Cell 3",landline:"Landline","landline 2":"Landline 2","landline 3":"Landline 3","landline 4":"Landline 4",
          "email 1":"Email 1","email 2":"Email 2","email 3":"Email 3","dnc":"DNC","dnc 2":"DNC 2","dnc 3":"DNC 3","dnc 4":"DNC 4",
          status:"Status",type:"Type","lot acres":"Acreage","lot size (acres)":"Acreage"
        };
        const seen={};
        return headers.map(hRaw=>{
          const h=String(hRaw||"").trim();
          const norm = map[h.toLowerCase()] || h;
          if (seen[norm]==null){ seen[norm]=0; return norm; }
          seen[norm]+=1; return `${norm} (${seen[norm]})`;
        });
      }
      function rowsToObjects(rows){
        if(!rows.length) return [];
        const headers = normalizeHeaders(rows[0]);
        const out = [];
        for(let i=1;i<rows.length;i++){
          const r=rows[i]; if(!r || r.every(x=>String(x||"").trim()==="")) continue;
          const o={}; for(let c=0;c<headers.length;c++) o[headers[c]]=r[c]??"";
          if(!o["Owner Name"]){
            const comp=(o["Company Name"]||"").trim();
            const fn=(o["First Name"]||"").trim(), ln=(o["Last Name"]||"").trim();
            const person=[fn,ln].filter(Boolean).join(" ");
            o["Owner Name"] = comp && person ? `${comp} ‚Äî ${person}` : (comp || person);
          }
          if(!o["Site Address"]){
            const street=(o["Street Address"]||"").trim();
            const city=(o["City"]||"").trim(), state=(o["State"]||"").trim(), zip=(o["Zip"]||"").trim();
            const parts=[street,[city,state].filter(Boolean).join(", "),zip].filter(Boolean);
            if(parts.length) o["Site Address"]=parts.join(", ");
          }
          if(!o["County"]) o["County"]="";
          out.push(o);
        }
        return out;
      }
      const leadKey = (o)=>`${(o["APN"]||"").toLowerCase()}|${(o["Site Address"]||"").toLowerCase()}`;
      const dedupeAppend = (existing, incoming)=>{
        const seen = new Set(existing.map(leadKey)); const merged=existing.slice();
        for(const it of incoming){ const k=leadKey(it); if(!seen.has(k)){ merged.push(it); seen.add(k);} }
        return merged;
      };
      function handleLeadUpload(e){
        const file=e.target.files?.[0]; if(!file) return;
        const reader=new FileReader();
        reader.onload=(evt)=>{
          try{
            const rows=parseCSV(String(evt.target.result||""));
            const objs=rowsToObjects(rows).map(cleanLeadRecord);
            setLeads(prev=> importMode==="replace" ? objs : dedupeAppend(prev, objs));
            setSelectedIndex(0);
          }catch(err){ alert("Unable to parse leads CSV: "+err); }
        };
        reader.readAsText(file);
      }
      function handleBuyerUpload(e){
        const file=e.target.files?.[0]; if(!file) return;
        const reader=new FileReader();
        reader.onload=(evt)=>{
          try{
            const rows=parseCSV(String(evt.target.result||""));
            const objs=rowsToObjects(rows).map(cleanBuyerRecord);
            setBuyers(prev=> buyersImportMode==="replace" ? objs : prev.concat(objs));
          }catch(err){ alert("Unable to parse buyers CSV: "+err); }
        };
        reader.readAsText(file);
      }

      // Derived
      const filteredLeads = React.useMemo(()=>{
        let list=leads;
        const q=search.trim().toLowerCase();
        if(q) list=list.filter(l => (l["Owner Name"]||"").toLowerCase().includes(q) || (l["County"]||"").toLowerCase().includes(q) || (l["Site Address"]||"").toLowerCase().includes(q));
        if(countyFilter) list=list.filter(l => (l["County"]||"").toLowerCase()===countyFilter.toLowerCase());
        return list;
      },[leads,search,countyFilter]);
      const leadCounties = React.useMemo(()=>{
        const set=new Set(); for(const l of leads) if(l["County"]) set.add(String(l["County"]).trim());
        return Array.from(set).sort((a,b)=>a.localeCompare(b));
      },[leads]);
      const selectedIndexSafe = useMemo(()=>{
        if(!filteredLeads.length) return -1;
        return Math.min(Math.max(selectedIndex, 0), filteredLeads.length-1);
      },[filteredLeads, selectedIndex]);
      useEffect(()=>{
        if(selectedIndexSafe===-1 && filteredLeads.length){
          setSelectedIndex(0);
        }
      },[filteredLeads.length, selectedIndexSafe]);
      const selectedLead = selectedIndexSafe>=0 ? filteredLeads[selectedIndexSafe] : null;
      const selectedLeadId = selectedLead?.__id;
      const selectedNeedsGeocode = selectedLead ? !leadHasCoordinates(selectedLead) : false;
      useEffect(()=>{ setLeadLogText(""); setLeadLogType("Note"); },[selectedLeadId]);

      const assignedBuyer = useMemo(()=> selectedLead ? buyers.find(b=>b.__id===selectedLead.__assignedBuyerId) || null : null, [buyers, selectedLead]);
      const matchingBuyers = useMemo(()=>{
        if(!selectedLead) return [];
        const county=(selectedLead["County"]||"").toLowerCase();
        const acres=toNumber(selectedLead["Acreage"]);
        const value=toNumber(selectedLead["Estimated Market Value"]);
        return buyers.filter(b=>{
          const counties=(b["Buy Box - Counties"]||"").toLowerCase();
          const countyOK=!county || counties.includes(county);
          const minA=toNumber(b["Min Acres"]); const maxA=toNumber(b["Max Acres"]);
          const minP=toNumber(b["Min Price"]); const maxP=toNumber(b["Max Price"]);
          const acresOK = !Number.isFinite(acres) || ((minA??-Infinity) <= acres && (maxA??Infinity) >= acres);
          const priceOK = !Number.isFinite(value) || ((minP??-Infinity) <= value && (maxP??Infinity) >= value);
          return countyOK && acresOK && priceOK;
        });
      },[buyers, selectedLead]);
      const selectedLeadPhones = useMemo(()=>{
        if(!selectedLead) return [];
        const seen = new Set();
        const entries = [];
        for(const field of PHONE_FIELDS){
          const raw = selectedLead[field];
          const display = typeof raw === "number" ? String(raw) : String(raw ?? "").trim();
          if(!display) continue;
          const href = normalizePhoneHref(display);
          if(!href) continue;
          if(seen.has(href)) continue;
          seen.add(href);
          entries.push({label: field, display, href});
        }
        return entries;
      },[selectedLead]);
      const selectedLeadEmails = useMemo(()=>{
        if(!selectedLead) return [];
        const seen = new Set();
        const entries = [];
        for(const field of EMAIL_FIELDS){
          const raw = selectedLead[field];
          const value = typeof raw === "string" ? raw.trim() : String(raw ?? "").trim();
          if(!value) continue;
          const key = value.toLowerCase();
          if(seen.has(key)) continue;
          seen.add(key);
          entries.push({label: field, value});
        }
        return entries;
      },[selectedLead]);

      // Map URL
      const mapURL = React.useMemo(()=>{
        if(!selectedLead || typeof selectedLead?.Latitude!=="number" || typeof selectedLead?.Longitude!=="number") return "";
        const lat=selectedLead.Latitude, lon=selectedLead.Longitude;
        if(mapType==="satellite") return `https://www.google.com/maps?hl=en&q=${lat},${lon}&t=k&z=16&output=embed`;
        const d=0.01; const bbox=`${lon-d},${lat-d},${lon+d},${lat+d}`;
        return `https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${lat},${lon}`;
      },[selectedLead,mapType]);

      // Buyers
      const buyerCounties = React.useMemo(()=>{
        const set=new Set(); for(const b of buyers)(b["Buy Box - Counties"]||"").split(/[,;|]/).forEach(x=>{ const v=x.trim(); if(v) set.add(v); });
        return Array.from(set).sort((a,b)=>a.localeCompare(b));
      },[buyers]);
      const filteredBuyers = React.useMemo(()=>{
        const n=(x)=>{ const v=Number(String(x??"").replace(/[$,\s]/g,"")); return Number.isFinite(v)?v:undefined; };
        const minA=n(minAcres)??-Infinity, maxA=n(maxAcres)??Infinity;
        const minP=n(minPrice)??-Infinity, maxP=n(maxPrice)??Infinity;
        return buyers.filter(b=>{
          const acresOK = (()=>{ const lo=n(b["Min Acres"])??-Infinity, hi=n(b["Max Acres"])??Infinity; return lo<=maxA && hi>=minA; })();
          const priceOK = (()=>{ const lo=n(b["Min Price"])??-Infinity, hi=n(b["Max Price"])??Infinity; return lo<=maxP && hi>=minP; })();
          const countyOK = !buyerCounty || (b["Buy Box - Counties"]||"").toLowerCase().includes(buyerCounty.toLowerCase());
          return acresOK && priceOK && countyOK;
        });
      },[buyers,minAcres,maxAcres,minPrice,maxPrice,buyerCounty]);
      useEffect(()=>{
        if(filteredBuyers.length){
          if(!selectedBuyerId || !filteredBuyers.some(b=>b.__id===selectedBuyerId)){
            setSelectedBuyerId(filteredBuyers[0].__id);
          }
        }else if(selectedBuyerId){
          setSelectedBuyerId(null);
        }
      },[filteredBuyers, selectedBuyerId]);
      const selectedBuyer = useMemo(()=>{
        if(!filteredBuyers.length) return null;
        return filteredBuyers.find(b=>b.__id===selectedBuyerId) || filteredBuyers[0];
      },[filteredBuyers, selectedBuyerId]);
      const selectedBuyerSafeId = selectedBuyer?.__id || null;
      useEffect(()=>{ setBuyerLogText(""); },[selectedBuyerSafeId]);
      const assignedLeadsForBuyer = useMemo(()=>{
        if(!selectedBuyer) return [];
        return leads.filter(l=>l.__assignedBuyerId===selectedBuyer.__id);
      },[leads, selectedBuyer]);

      function handleAddLeadHistory(){
        if(!selectedLeadId || !leadLogText.trim()) return;
        const entry = makeHistoryEntry(leadLogType, leadLogText.trim());
        updateLeadById(selectedLeadId, current=>({
          ...current,
          __history:[entry,...(current.__history||[])]
        }));
        setLeadLogText("");
      }
      function handleDeleteLeadHistory(id){
        if(!selectedLeadId) return;
        updateLeadById(selectedLeadId, current=>({
          ...current,
          __history:(current.__history||[]).filter(entry=>entry.id!==id)
        }));
      }
      function handleAddBuyerHistory(){
        if(!selectedBuyerSafeId || !buyerLogText.trim()) return;
        const entry=makeHistoryEntry(buyerLogType, buyerLogText.trim());
        updateBuyerById(selectedBuyerSafeId, current=>({
          ...current,
          __history:[entry,...(current.__history||[])]
        }));
        setBuyerLogText("");
      }
      function handleDeleteBuyerHistory(id){
        if(!selectedBuyerSafeId) return;
        updateBuyerById(selectedBuyerSafeId, current=>({
          ...current,
          __history:(current.__history||[]).filter(entry=>entry.id!==id)
        }));
      }
      function handleAssignBuyer(lead, buyerId){
        if(!lead) return;
        const leadId = lead.__id;
        const nextId = buyerId || null;
        const prevId = lead.__assignedBuyerId || null;
        if(prevId===nextId) return;
        updateLeadById(leadId, current=>{
          const history=current.__history?current.__history.slice():[];
          let entry=null;
          if(nextId){
            const buyer = buyers.find(b=>b.__id===nextId);
            entry = makeHistoryEntry("Assignment", `Assigned to ${buyerLabel(buyer)}`);
          }else if(prevId){
            const prevBuyer = buyers.find(b=>b.__id===prevId);
            entry = makeHistoryEntry("Assignment", `Unassigned from ${buyerLabel(prevBuyer)}`);
          }
          if(entry) history.unshift(entry);
          return {...current, __assignedBuyerId:nextId, __history:history};
        });
        if(prevId && prevId!==nextId){
          updateBuyerById(prevId, current=>({
            ...current,
            __history:[makeHistoryEntry("Lead Assignment", `Lead unassigned: ${leadLabel(lead)}`), ...(current.__history||[])]
          }));
        }
        if(nextId){
          updateBuyerById(nextId, current=>({
            ...current,
            __history:[makeHistoryEntry("Lead Assignment", `Lead assigned: ${leadLabel(lead)}`), ...(current.__history||[])]
          }));
        }
      }

      // Export
      function exportCSV(data, filename){
        if(!data?.length) return;
        const headers = Object.keys(data[0]);
        const body = data.map(row => headers.map(h => `"${String((row[h]??"")).replaceAll('"','""')}"`).join(",")).join("\n");
        const csv = headers.join(",") + "\n" + body;
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
        const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      // Comps
      function distMiles(a1,b1,a2,b2){
        const toRad=(d)=>d*Math.PI/180, R=3958.8;
        const dLat=toRad(a2-a1), dLon=toRad(b2-b1);
        const A=Math.sin(dLat/2)**2 + Math.cos(toRad(a1))*Math.cos(toRad(a2))*Math.sin(dLon/2)**2;
        return 2*R*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));
      }

      const comps = React.useMemo(()=>{
        const sel=selectedLead;
        if(!sel || typeof sel?.Latitude!=="number" || typeof sel?.Longitude!=="number") return [];
        const out=[];
        for(const l of leads){
          if(l===sel) continue;
          const lat=l?.Latitude, lon=l?.Longitude;
          if(typeof lat!=="number" || typeof lon!=="number") continue;
          const distance=distMiles(sel.Latitude, sel.Longitude, lat, lon);
          if(distance<=compRadius) out.push({
            owner:l["Owner Name"]||"‚Äî", address:l["Site Address"]||"‚Äî", county:l["County"]||"‚Äî",
            value:l["Estimated Market Value"]||"", acreage:l["Acreage"]||"", distance
          });
        }
        return out.sort((a,b)=>a.distance-b.distance).slice(0,50);
      },[leads,selectedLead,compRadius]);

      // Geocode
      const missingCount = useMemo(()=> leads.filter(l => !leadHasCoordinates(l)).length, [leads]);
      const buildQueryFromLead = typeof CRM.buildGeocodeQuery === "function" ? CRM.buildGeocodeQuery : ((l)=>{
        if(!l) return "";
        const siteCity = l["City"] || l["Site City"];
        const siteState = l["State"] || l["Site State"];
        const siteZip = l["Zip"] || l["Site Zip"];
        const cityState = [siteCity, siteState].filter(Boolean).join(", ");
        if(l["Site Address"]){
          const parts = [l["Site Address"]];
          if(cityState) parts.push(cityState);
          if(siteZip) parts.push(siteZip);
          if(l["County"]) parts.push(`${l["County"]} County`);
          return parts.join(", ");
        }
        const mailingParts = [l["Street Address"], cityState, siteZip].filter(Boolean);
        if(mailingParts.length){
          if(l["County"]){
            mailingParts.push(`${l["County"]} County`);
          }
          return mailingParts.join(", ");
        }
        const apn = String(l["APN"]||"").trim();
        if(apn) return apn;
        return String(l["Owner Name"]||"").trim();
      });
      async function lookupCoords(query){
        if(!query) return null;
        const cache = geocodeCacheRef.current;
        if(cache.has(query)) return cache.get(query);
        for(const provider of GEOCODE_PROVIDERS){
          try{
            const url = provider.buildUrl(query);
            const res = await fetch(url,{headers:{'Accept':'application/json'}});
            if(!res.ok) continue;
            const data = await res.json();
            const coords = provider.parse(data);
            if(coords){
              const result = {...coords, provider:provider.name};
              cache.set(query, result);
              return result;
            }
          }catch(err){
            console.warn(`Geocode provider ${provider.name} failed for ${query}`, err);
          }
        }
        cache.set(query, null);
        return null;
      }
      async function geocodeMissing(){
        if(geocodeBusy) return;
        let targets = leads.map((l,idx)=>({l,idx})).filter(x=> !leadHasCoordinates(x.l));
        if(!targets.length && selectedNeedsGeocode && selectedLeadId){
          const idx = leads.findIndex(l=>l.__id===selectedLeadId);
          if(idx!==-1) targets = [{l:leads[idx], idx}];
        }
        if(!targets.length){
          setGeocodeStatus("All leads already have coordinates.");
          return;
        }
        setGeocodeBusy(true);
        setGeocodeStatus("Starting geocode run‚Ä¶");
        setGeocodeProgress({done:0,total:targets.length});
        const updated=leads.slice();
        let changed=false;
        let successCount=0, failCount=0, skippedCount=0;
        let lastProvider="";
        for(let i=0;i<targets.length;i++){
          const {l,idx}=targets[i];
          const q=buildQueryFromLead(l);
          if(!q){
            skippedCount++;
            setGeocodeProgress({done:i+1,total:targets.length});
            continue;
          }
          try{
            const coords = await lookupCoords(q);
            if(coords){
              lastProvider = coords.provider || lastProvider;
              const lat=Number(coords.lat ?? coords.latitude);
              const lon=Number(coords.lon ?? coords.lng ?? coords.longitude);
              if(Number.isFinite(lat) && Number.isFinite(lon)){
                updated[idx]={...updated[idx], Latitude:lat, Longitude:lon};
                changed=true;
                successCount++;
              }else{
                failCount++;
              }
            }else{
              failCount++;
            }
          }catch(e){
            failCount++;
            console.warn("Geocode failed for", q, e);
          }
          setGeocodeProgress({done:i+1,total:targets.length});
          if(i<targets.length-1) await sleep(1200);
        }
        if(changed) setLeads(updated.slice());
        setGeocodeBusy(false);
        const pieces=[];
        if(successCount) pieces.push(`Geocoded ${successCount} of ${targets.length} leads${lastProvider?` via ${lastProvider}`:""}.`);
        if(failCount) pieces.push(`${failCount} queries had no match.`);
        if(skippedCount) pieces.push(`${skippedCount} missing enough address info.`);
        if(!pieces.length) pieces.push("No coordinates found. Add more address details and try again.");
        setGeocodeStatus(pieces.join(" "));
      }

      // UI
      return (
        <>
          <h1>üè° Wholesale Land CRM (Web)</h1>
          <div className="tabs row mb-16">
            <button className={tab==="leads"?"active":""} onClick={()=>setTab("leads")}>Leads</button>
            <button className={tab==="buyers"?"active":""} onClick={()=>setTab("buyers")}>Buyers</button>
          </div>

          {tab==="leads" ? (
            <>
              <div className="row mb-16">
                <input type="file" accept=".csv" onChange={handleLeadUpload} className="w-72"/>
                <div className="row">
                  <label className="small">Import mode:</label>
                  <select value={importMode} onChange={e=>setImportMode(e.target.value)}>
                    <option value="append">Append (de-dup)</option>
                    <option value="replace">Replace all</option>
                  </select>
                </div>
                <input className="input" placeholder="Search owner, county, or address" value={search} onChange={e=>setSearch(e.target.value)} />
                <select value={countyFilter} onChange={e=>setCountyFilter(e.target.value)}>
                  <option value="">All Counties</option>
                  {leadCounties.map(c => <option key={c} value={c}>{c}</option>)}
                </select>
                <button className="btn brand" onClick={()=>exportCSV(leads,"Wholesale_Land_Leads.csv")}>Export CSV</button>
                <button className="btn ghost" onClick={()=>{const sample=sampleLeads.map(cleanLeadRecord); setLeads(sample); setSelectedIndex(0);}}>Load Sample</button>
                <button className="btn" disabled={geocodeBusy || (!missingCount && !selectedNeedsGeocode)} onClick={geocodeMissing}>
                  {geocodeBusy
                    ? `Geocoding ${geocodeProgress.done}/${geocodeProgress.total}‚Ä¶`
                    : missingCount
                      ? `Geocode Missing (${missingCount})`
                      : selectedNeedsGeocode
                        ? "Geocode Selected Lead"
                        : "Geocode Missing (0)"}
                </button>
              </div>
              {geocodeStatus && (
                <div className="muted" style={{fontSize:"12px", marginTop:"-8px", marginBottom:"8px"}}>{geocodeStatus}</div>
              )}

              <div className="grid grid-2">
                <div className="card hview">
                  <div className="hd">
                    <div>üìã Leads ({filteredLeads.length})</div>
                    <div className="muted">Tip: Missing coordinates? Use <span className="kbd">Geocode Missing</span>.</div>
                  </div>
                  <div className="scroll">
                    <table>
                      <thead><tr><th>Owner</th><th>County</th><th>Site Address</th><th>Est. Value</th></tr></thead>
                      <tbody>
                        {filteredLeads.map((l,i)=>(
                          <tr key={(l["APN"]||"")+i} className={i===selectedIndexSafe?"selected":""} onClick={()=>setSelectedIndex(i)} style={{cursor:"pointer"}}>
                            <td>{l["Owner Name"]||"‚Äî"}</td>
                            <td>{l["County"]||"‚Äî"}</td>
                            <td>{l["Site Address"]||"‚Äî"}</td>
                            <td>{l["Estimated Market Value"]||"‚Äî"}</td>
                          </tr>
                        ))}
                        {!filteredLeads.length && <tr><td colSpan="4" className="center" style={{padding:"24px"}}>No leads match your filters.</td></tr>}
                      </tbody>
                    </table>
                  </div>
                </div>

                <div className="card hview">
                  <div className="hd">
                    <div>üó∫Ô∏è Map & Details</div>
                    <div className="row small">
                      <label><input type="checkbox" checked={mapEnabled} onChange={e=>setMapEnabled(e.target.checked)} /> Map</label>
                      <label>Map Type:
                        <select value={mapType} onChange={e=>setMapType(e.target.value)}>
                          <option value="street">Street</option>
                          <option value="satellite">Satellite</option>
                        </select>
                      </label>
                    </div>
                  </div>
                  <div className="scroll" style={{padding:"12px"}}>
                    {selectedLead ? (
                      <>
                        <div style={{border:"1px solid var(--line)", borderRadius:"12px", overflow:"hidden", minHeight:"260px", background:"#fff", marginBottom:"12px"}}>
                          {mapEnabled && mapURL
                            ? <iframe title="map" src={mapURL} style={{border:0,width:"100%",height:"100%",minHeight:"260px"}} loading="lazy" referrerPolicy="no-referrer-when-downgrade"></iframe>
                            : <div className="muted" style={{padding:"24px",textAlign:"center"}}>Provide coordinates to view map.</div>}
                        </div>

                        <div className="row-details" style={{marginBottom:"16px"}}>
                          <Info label="Owner" value={selectedLead?.["Owner Name"]} />
                          <Info label="County" value={selectedLead?.["County"]} />
                          <Info label="Address" value={selectedLead?.["Site Address"]} />
                          <Info label="APN" value={selectedLead?.["APN"]} />
                          <Info label="Acreage" value={selectedLead?.["Acreage"]} />
                          <Info label="Est. Value" value={selectedLead?.["Estimated Market Value"]} />
                          <Info label="Latitude" value={String(selectedLead?.["Latitude"] ?? "")} />
                          <Info label="Longitude" value={String(selectedLead?.["Longitude"] ?? "")} />
                        </div>

                        <div style={{borderTop:"1px solid var(--line)", paddingTop:"12px", marginBottom:"16px"}}>
                          <div style={{fontWeight:600, marginBottom:"8px"}}>üìû Contact Details</div>
                          <div style={{display:"grid", gap:"12px", gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))"}}>
                            <div>
                              <div className="muted" style={{fontSize:"11px", textTransform:"uppercase", letterSpacing:"0.05em", marginBottom:"6px"}}>Phone</div>
                              {selectedLeadPhones.length ? (
                                <div style={{display:"flex", flexDirection:"column", gap:"6px"}}>
                                  {selectedLeadPhones.map(phone=>(
                                    <a key={`${phone.label}-${phone.href}`} className="btn ghost" href={`tel:${phone.href}`}
                                      style={{textDecoration:"none", display:"flex", justifyContent:"space-between", alignItems:"center"}}>
                                      <span>{phone.display}</span>
                                      <span className="muted" style={{fontSize:"11px"}}>{phone.label}</span>
                                    </a>
                                  ))}
                                </div>
                              ) : (
                                <div className="muted small">No phone numbers yet.</div>
                              )}
                            </div>
                            <div>
                              <div className="muted" style={{fontSize:"11px", textTransform:"uppercase", letterSpacing:"0.05em", marginBottom:"6px"}}>Email</div>
                              {selectedLeadEmails.length ? (
                                <div style={{display:"flex", flexDirection:"column", gap:"6px"}}>
                                  {selectedLeadEmails.map(email=>(
                                    <a key={`${email.label}-${email.value}`} className="btn ghost" href={`mailto:${encodeURIComponent(email.value)}`}
                                      style={{textDecoration:"none", display:"flex", justifyContent:"space-between", alignItems:"center"}}>
                                      <span>{email.value}</span>
                                      <span className="muted" style={{fontSize:"11px"}}>{email.label}</span>
                                    </a>
                                  ))}
                                </div>
                              ) : (
                                <div className="muted small">No emails yet.</div>
                              )}
                            </div>
                          </div>
                        </div>

                        <div style={{borderTop:"1px solid var(--line)", paddingTop:"12px"}}>
                          <div className="row mb-8">
                            {["New","Attempted","Contacted","Offer Sent","Under Contract","Dead"].map(s=>(
                              <span key={s} className={"chip "+(selectedLead?.Status===s?"active":"")} onClick={()=>{
                                if(!selectedLeadId) return;
                                updateLeadById(selectedLeadId, current=>{
                                  if(current.Status===s) return current;
                                  const entry = makeHistoryEntry("Status", `Status changed to ${s}`);
                                  return {...current, Status:s, __history:[entry,...(current.__history||[])]};
                                });
                              }}>{s}</span>
                            ))}
                          </div>
                          <div className="row mb-8">
                            <input className="input" placeholder="Next Action (e.g., Call Tue 10am)" value={selectedLead?.__nextAction||""}
                              onChange={e=>{ if(!selectedLeadId) return; updateLeadById(selectedLeadId, current=>({...current,__nextAction:e.target.value})); }} />
                            <input type="date" value={selectedLead?.__lastContacted||""}
                              onChange={e=>{ if(!selectedLeadId) return; updateLeadById(selectedLeadId, current=>({...current,__lastContacted:e.target.value})); }} />
                          </div>
                          {selectedLead?.__notes ? (
                            <div className="mb-8" style={{background:"#f1f5f9", borderRadius:"12px", padding:"12px"}}>
                              <div className="muted" style={{fontSize:"11px", textTransform:"uppercase", letterSpacing:"0.05em"}}>Pinned Note</div>
                              <div style={{whiteSpace:"pre-wrap", marginTop:"4px"}}>{selectedLead.__notes}</div>
                            </div>
                          ) : null}

                          <div className="row mt-16 mb-8" style={{alignItems:"center", justifyContent:"space-between"}}>
                            <div style={{fontWeight:600}}>ü§ù Assign to Buyer</div>
                            {assignedBuyer && <div className="muted" style={{fontSize:"12px"}}>Assigned to: {buyerLabel(assignedBuyer)}</div>}
                          </div>
                          <div className="row mb-8" style={{alignItems:"center"}}>
                            <select value={selectedLead?.__assignedBuyerId||""} onChange={e=>handleAssignBuyer(selectedLead, e.target.value)} style={{minWidth:"200px"}}>
                              <option value="">Unassigned</option>
                              {buyers.map(b=>(<option key={b.__id} value={b.__id}>{buyerLabel(b)}</option>))}
                            </select>
                          </div>
                          {matchingBuyers.length ? (
                            <div className="mb-8">
                              <div className="muted" style={{fontSize:"12px", marginBottom:"4px"}}>Suggested buyers (click to assign)</div>
                              <div className="row" style={{gap:"8px"}}>
                                {matchingBuyers.slice(0,6).map(b=>(
                                  <span key={b.__id} className={"chip "+(selectedLead?.__assignedBuyerId===b.__id?"active":"")} onClick={()=>handleAssignBuyer(selectedLead, b.__id)}>{buyerLabel(b)}</span>
                                ))}
                              </div>
                            </div>
                          ) : null}

                          <div className="row mt-16 mb-8" style={{justifyContent:"space-between", alignItems:"center"}}>
                            <div style={{fontWeight:600}}>üìù History Log</div>
                          </div>
                          <HistoryLog entries={selectedLead?.__history||[]} type={leadLogType} text={leadLogText}
                            onTypeChange={setLeadLogType} onTextChange={setLeadLogText}
                            onAdd={handleAddLeadHistory} onDelete={handleDeleteLeadHistory}
                            placeholder="Add call notes, offer details, or follow-up tasks" />

                          <div className="row mt-16 mb-8" style={{justifyContent:"space-between"}}>
                            <div style={{fontWeight:600}}>üìå Nearby Comps</div>
                            <div className="row small">
                              <span>Radius (miles)</span>
                              <input className="w-20" type="number" min="1" step="1" value={compRadius}
                                onChange={e=>setCompRadius(Math.max(1, Number(e.target.value)||1))}/>
                            </div>
                          </div>
                          {comps.length ? (
                            <div className="table-lite">
                              <table>
                                <thead><tr><th>Dist (mi)</th><th>Owner</th><th>Address</th><th>County</th><th>Est. Value</th><th>Acreage</th></tr></thead>
                                <tbody>
                                  {comps.map((c,i)=>(
                                    <tr key={i}><td>{c.distance.toFixed(2)}</td><td>{c.owner}</td><td>{c.address}</td><td>{c.county}</td><td>{c.value||"‚Äî"}</td><td>{c.acreage||"‚Äî"}</td></tr>
                                  ))}
                                </tbody>
                              </table>
                            </div>
                          ) : <div className="muted">No comps found within {compRadius} miles.</div> }
                        </div>
                      </>
                    ) : (
                      <div className="muted" style={{padding:"24px", textAlign:"center"}}>Select a lead from the table to view details.</div>
                    )}
                  </div>
                </div>
              </div>

              <div className="card mt-16" style={{padding:"16px"}}>
                <AddLeadForm onAdd={(obj)=>{ const cleaned=cleanLeadRecord(obj); setLeads(prev=>dedupeAppend(prev,[cleaned])); setSelectedIndex(0); }}/>
              </div>

              <Tests/>
            </>
          ) : (
            <>
              <div className="row mb-16">
                <input type="file" accept=".csv" onChange={handleBuyerUpload} className="w-72"/>
                <div className="row">
                  <label className="small">Import mode:</label>
                  <select value={buyersImportMode} onChange={e=>setBuyersImportMode(e.target.value)}>
                    <option value="append">Append</option>
                    <option value="replace">Replace all</option>
                  </select>
                </div>
                <select value={buyerCounty} onChange={e=>setBuyerCounty(e.target.value)}>
                  <option value="">All Counties</option>
                  {buyerCounties.map(c=><option key={c} value={c}>{c}</option>)}
                </select>
                <input className="input" placeholder="Min Acres" value={minAcres} onChange={e=>setMinAcres(e.target.value)} />
                <input className="input" placeholder="Max Acres" value={maxAcres} onChange={e=>setMaxAcres(e.target.value)} />
                <input className="input" placeholder="Min Price" value={minPrice} onChange={e=>setMinPrice(e.target.value)} />
                <input className="input" placeholder="Max Price" value={maxPrice} onChange={e=>setMaxPrice(e.target.value)} />
                <button className="btn brand" onClick={()=>exportCSV(buyers,"Wholesale_Land_Buyers.csv")}>Export CSV</button>
                <button className="btn ghost" onClick={()=>{
                  const sample = sampleBuyers.map(cleanBuyerRecord);
                  setBuyers(sample);
                  setSelectedBuyerId(sample[0]?.__id || null);
                }}>Load Sample</button>
              </div>


              <div className="grid grid-2">
                <div className="card hview">
                  <div className="hd">üß∞ Buyers ({filteredBuyers.length})</div>
                  <div className="scroll">
                    <table>
                      <thead><tr><th>Buyer / Company</th><th>Counties</th><th>Acres</th><th>Price</th><th>Funding</th><th>Contact</th></tr></thead>
                      <tbody>
                        {filteredBuyers.map(b=>(
                          <tr key={b.__id} className={selectedBuyerSafeId===b.__id?"selected":""} onClick={()=>setSelectedBuyerId(b.__id)} style={{cursor:"pointer"}}>
                            <td>{b["Buyer Name / Company"]||"‚Äî"}</td>
                            <td>{b["Buy Box - Counties"]||"‚Äî"}</td>
                            <td>{[b["Min Acres"], b["Max Acres"]].filter(Boolean).join(" - ") || "‚Äî"}</td>
                            <td>{[b["Min Price"], b["Max Price"]].filter(Boolean).join(" - ") || "‚Äî"}</td>
                            <td>{b["Funding Type (Cash/Hard Money)"]||"‚Äî"}</td>
                            <td>{[b["Phone"], b["Email"]].filter(Boolean).join(" | ") || "‚Äî"}</td>
                          </tr>
                        ))}
                        {!filteredBuyers.length && <tr><td colSpan="6" className="center" style={{padding:"24px"}}>No buyers match your filters.</td></tr>}
                      </tbody>
                    </table>
                  </div>
                </div>

                <div className="card hview">
                  <div className="hd">üìá Buyer Details</div>
                  <div className="scroll" style={{padding:"12px"}}>
                    {selectedBuyer ? (
                      <div>
                        <div className="row-details">
                          <Info label="Company / Buyer" value={selectedBuyer["Buyer Name / Company"]} />
                          <Info label="Buy Counties" value={selectedBuyer["Buy Box - Counties"]} />
                          <Info label="Buy States" value={selectedBuyer["Buy Box - States"]} />
                          <Info label="Acreage" value={[selectedBuyer["Min Acres"], selectedBuyer["Max Acres"]].filter(Boolean).join(" - ") || ""} />
                          <Info label="Price Range" value={[selectedBuyer["Min Price"], selectedBuyer["Max Price"]].filter(Boolean).join(" - ") || ""} />
                          <Info label="Funding" value={selectedBuyer["Funding Type (Cash/Hard Money)"]} />
                          <Info label="Phone" value={selectedBuyer["Phone"]} />
                          <Info label="Email" value={selectedBuyer["Email"]} />
                        </div>

                        {selectedBuyer.__notes ? (
                          <div className="mt-16" style={{background:"#f1f5f9", borderRadius:"12px", padding:"12px"}}>
                            <div className="muted" style={{fontSize:"11px", textTransform:"uppercase", letterSpacing:"0.05em"}}>Pinned Note</div>
                            <div style={{whiteSpace:"pre-wrap", marginTop:"4px"}}>{selectedBuyer.__notes}</div>
                          </div>
                        ) : null}

                        <div className="mt-16">
                          <div style={{fontWeight:600}} className="mb-8">üìÅ Assigned Leads</div>
                          {assignedLeadsForBuyer.length ? (
                            <div style={{maxHeight:"180px", overflow:"auto", border:"1px solid var(--line)", borderRadius:"12px", padding:"8px"}}>
                              {assignedLeadsForBuyer.map(lead=>(
                                <div key={lead.__id} style={{borderBottom:"1px solid var(--line)", padding:"6px 4px"}}>
                                  <div style={{fontWeight:600}}>{lead["Owner Name"]||"‚Äî"}</div>
                                  <div className="muted" style={{fontSize:"12px"}}>{[lead["Site Address"]||"‚Äî", lead.County||"‚Äî", lead.Status||"‚Äî"].join(" ¬∑ ")}</div>
                                </div>
                              ))}
                            </div>
                          ) : <div className="muted">No leads assigned yet.</div>}
                        </div>

                        <div className="mt-16">
                          <div style={{fontWeight:600}} className="mb-8">üìù History Log</div>
                          <HistoryLog entries={selectedBuyer.__history||[]} type={buyerLogType} text={buyerLogText}
                            onTypeChange={setBuyerLogType} onTextChange={setBuyerLogText}
                            onAdd={handleAddBuyerHistory} onDelete={handleDeleteBuyerHistory}
                            placeholder="Add call notes, funding updates, or deal progress" />
                        </div>
                      </div>
                    ) : <div className="muted" style={{padding:"24px"}}>No buyer selected.</div>}
                  </div>
                </div>
              </div>
              <div className="card mt-16" style={{padding:"16px"}}>
                <AddBuyerForm onAdd={(obj)=> setBuyers(prev=>prev.concat([cleanBuyerRecord(obj)])) }/>
              </div>

              <div className="card mt-16" style={{padding:"16px"}}>
                <div className="muted">CSV buyer headers: <code>Buyer Name / Company, Phone, Email, Buy Box - Counties, Buy Box - States, Min Acres, Max Acres, Min Price, Max Price, Funding Type (Cash/Hard Money)</code></div>
              </div>
            </>
          )}
        </>
      );
    }

    function Info({label, value}){ return <div className="info"><label>{label}</label><div>{value||"‚Äî"}</div></div>; }

    function AddLeadForm({onAdd}){
      const [form,setForm]=React.useState({"Owner Name":"",County:"","Site Address":"","Estimated Market Value":"",Latitude:"",Longitude:"",APN:"",Acreage:""});
      return (
        <div>
          <div style={{fontWeight:600}} className="mb-8">‚ûï Add a Single Lead</div>
          <div className="row">
            {Object.keys(form).map(k=>(
              <input key={k} className="input" placeholder={k} value={form[k]} onChange={e=>setForm({...form,[k]:e.target.value})}/>
            ))}
          </div>
          <div className="row mt-12">
            <button className="btn brand" onClick={()=>onAdd(form)}>Add Lead</button>
            <button className="btn ghost" onClick={()=>setForm({"Owner Name":"",County:"","Site Address":"","Estimated Market Value":"",Latitude:"",Longitude:"",APN:"",Acreage:""})}>Clear</button>
          </div>
        </div>
      );
    }


    function HistoryLog({entries, type, text, onTypeChange, onTextChange, onAdd, onDelete, placeholder}){
      const sorted = React.useMemo(()=>{
        if(!Array.isArray(entries)) return [];
        return entries.slice().sort((a,b)=>{
          const ta=Date.parse(b.timestamp||'');
          const tb=Date.parse(a.timestamp||'');
          return (Number.isFinite(ta)?ta:0)-(Number.isFinite(tb)?tb:0);
        });
      },[entries]);
      return (
        <div>
          <div className="row mb-8" style={{alignItems:"flex-start"}}>
            <select value={type} onChange={e=>onTypeChange?.(e.target.value)} style={{minWidth:"140px"}}>
              {HISTORY_TYPES.map(opt=><option key={opt} value={opt}>{opt}</option>)}
            </select>
            <textarea className="note" style={{flex:1, height:"72px"}} placeholder={placeholder||"Add note"} value={text||""}
              onChange={e=>onTextChange?.(e.target.value)}></textarea>
            <button className="btn indigo" onClick={onAdd} disabled={!String(text||"").trim()}>Log</button>
          </div>
          <div style={{maxHeight:"220px", overflow:"auto", border:"1px solid var(--line)", borderRadius:"12px", padding:"8px", background:"#fff"}}>
            {sorted.length ? sorted.map((entry,idx)=>{
              const dateLabel = formatDateTime(entry.timestamp);
              return (
                <div key={entry.id} style={{borderBottom:idx===sorted.length-1?"none":"1px solid var(--line)", padding:"8px 4px"}}>
                  <div style={{display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:"4px"}}>
                    <div style={{fontWeight:600}}>{entry.type||"Note"}</div>
                    <div className="muted" style={{fontSize:"11px"}}>{dateLabel}</div>
                  </div>
                  <div style={{whiteSpace:"pre-wrap"}}>{entry.note||"‚Äî"}</div>
                  {onDelete && (
                    <div className="row" style={{justifyContent:"flex-end", marginTop:"6px"}}>
                      <button className="btn ghost" style={{padding:"4px 8px", fontSize:"12px"}} onClick={()=>onDelete(entry.id)}>Remove</button>
                    </div>
                  )}
                </div>
              );
            }) : <div className="muted" style={{textAlign:"center", padding:"16px"}}>No history yet.</div>}
          </div>
        </div>
      );
    }

    function AddBuyerForm({onAdd}){
      const [form,setForm]=React.useState({"Buyer Name / Company":"","Phone":"","Email":"","Buy Box - Counties":"","Buy Box - States":"","Min Acres":"","Max Acres":"","Min Price":"","Max Price":"","Funding Type (Cash/Hard Money)":""
      });
      return (
        <div>
          <div style={{fontWeight:600}} className="mb-8">‚ûï Add a Single Buyer</div>
          <div className="row">
            {Object.keys(form).map(k=>(
              <input key={k} className="input" placeholder={k} value={form[k]} onChange={e=>setForm({...form,[k]:e.target.value})}/>
            ))}
          </div>
          <div className="row mt-12">
            <button className="btn brand" onClick={()=>onAdd(form)}>Add Buyer</button>
            <button className="btn ghost" onClick={()=>setForm({"Buyer Name / Company":"","Phone":"","Email":"","Buy Box - Counties":"","Buy Box - States":"","Min Acres":"","Max Acres":"","Min Price":"","Max Price":"","Funding Type (Cash/Hard Money)":""
            })}>Clear</button>
          </div>
        </div>
      );
    }

    function Tests(){
      return (
        <div className="card mt-16" style={{padding:"16px"}}>
          <div style={{fontWeight:600}} className="mb-8">‚úÖ Built-in Test Cases</div>
          <ul>
            <li>Load Sample ‚Üí click rows ‚Üí map shows by default; toggle Street/Satellite.</li>
            <li>Upload your PropStream contact export CSV ‚Üí rows & contact details appear.</li>
            <li>Switch Import mode between <i>Append</i> (de-dup APN+Address) and <i>Replace</i>.</li>
            <li>Use <b>Geocode Missing</b> to add coordinates for rows without lat/lon (progress updates, saved locally).</li>
            <li>Use <b>Estimate Selected</b> / <b>Estimate All Missing</b> for auto-valuation from comps.</li>
            <li>Adjust comps radius to see nearby properties from your dataset.</li>
            <li>Buyers: upload CSV, filter by county, acres, and price; add single buyer and review details panel.</li>
            <li>Use history logs to capture outreach on both leads and buyers; assign leads to buyers to build disposition pipeline.</li>
            <li>Refresh the page ‚Äî everything persists via LocalStorage.</li>
          </ul>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
